<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FINLOG â€” Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<header class="p-3 bg-white">
  <div class="d-flex justify-content-between align-items-center">
        <div class="header-left">
            <h1 class="m-0">FINLOG <span class="admin-badge">ADMIN</span></h1>
          </div>
        
          <div class="header-center flex-grow-1 d-flex justify-content-center">
            <input 
              type="search"
              class="form-control search-bar"
              placeholder="Search for a Place, Space or type of Fish!"
            >
          </div>
        
          <div class="header-right">
            <span class="me-2" id="loggedInUser">Admin</span>
            <a href="/logout" class="btn btn-outline-light">Logout</a>
          </div>
    </div>
</header>

  <div class="container-fluid py-1">
    <div class="row min-vh-100">
        <div class="col-md-3 d-none d-md-block bg-light">
        <div class="sticky-top py-4">
            <h5 class="mb-4">FinLog Admin</h5>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="home.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="dashboard.html">User Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="admin-dashboard.html">Admin Dashboard</a></li>
            </ul>
        </div>
    </div>
          
          
    <div class="col-md-9">

<main class="container my-4">
  
  
  <section class="mb-4">
    <h2 class="mb-3">Admin Overview</h2>
    <div class="row g-3">
      <div class="col-6 col-md-3">
        <div class="card text-center"><div class="card-body"><h3 id="stat-total-posts" class="text-primary">0</h3><div class="text-muted">Total Posts</div></div></div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center"><div class="card-body"><h3 id="stat-flagged" class="text-warning">0</h3><div class="text-muted">Flagged Posts</div></div></div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center"><div class="card-body"><h3 id="stat-pending" class="text-success">0</h3><div class="text-muted">Pending Review</div></div></div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center"><div class="card-body"><h3 id="stat-approved" class="text-info">0</h3><div class="text-muted">Approved</div></div></div>
      </div>
    </div>
  </section>

  
  <section class="mb-4">
    <div class="card">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="searchInput" class="form-label">Search Posts</label>
            <input type="text" class="form-control" id="searchInput" placeholder="Search by title or user...">
          </div>
          <div class="col-md-4">
            <label for="statusFilter" class="form-label">Status Filter</label>
            <select class="form-select" id="statusFilter">
              <option value="all">All Posts</option>
              <option value="pending">Pending Review</option>
              <option value="approved">Approved</option>
              <option value="flagged">Flagged</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-secondary w-100" id="clearFilters">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  
  <section>
    <div class="card">
      <div class="card-header"><h5 class="mb-0">Content Moderation Queue</h5></div>
      <div class="card-body">
        <div id="moderationQueue"></div>
      </div>
    </div>
  </section>
</main>

    </div>
  </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const moderationQueue = document.getElementById("moderationQueue");
let allPosts = [];
let currentUser = null;
let userRole = null;

// Check authentication and admin access
async function checkAdminAccess() {
  try {
    const response = await fetch('/api/auth/check');
    const result = await response.json();
    
    if (!result.authenticated) {
      window.location.href = 'login.html';
      return false;
    }
    
    currentUser = result.user;
    userRole = currentUser.role || 'user';
    
    // Update UI with username
    if (currentUser.username) {
      document.getElementById('loggedInUser').textContent = currentUser.username;
    }
    
    // Check if user is moderator or admin
    if (userRole !== 'admin' && userRole !== 'moderator') {
      alert('Access denied. Admin or moderator access required.');
      window.location.href = 'dashboard.html';
      return false;
    }
    
    return true;
  } catch (error) {
    console.error('Auth check failed:', error);
    window.location.href = 'login.html';
    return false;
  }
}

// Fetch all posts for moderation
async function loadPosts() {
  try {
    const response = await fetch('/api/admin/posts');
    const result = await response.json();
    
    if (result.status === 'success' && result.data) {
      allPosts = result.data;
      updateStats();
      renderPosts();
    } else {
      console.error('Failed to load posts:', result.message);
      moderationQueue.innerHTML = '<div class="text-center text-muted py-4">Failed to load posts. Please try again.</div>';
    }
  } catch (error) {
    console.error('Error loading posts:', error);
    // If unauthorized, redirect to login
    if (error.message.includes('401') || error.message.includes('403')) {
      window.location.href = 'login.html';
    } else {
      moderationQueue.innerHTML = '<div class="text-center text-muted py-4">Error loading posts. Please try again.</div>';
    }
  }
}

const mkImg = label => {
  const div = document.createElement("div");
  div.className = "bg-light d-flex align-items-center justify-content-center";
  div.style.height = "150px";
  div.textContent = label;
  return div;
};

function renderPosts(filteredPosts = null) {
  const posts = filteredPosts || allPosts;
  moderationQueue.innerHTML = "";
  
  if (posts.length === 0) {
    moderationQueue.innerHTML = '<div class="text-center text-muted py-4">No posts found matching your criteria.</div>';
    return;
  }

  posts.forEach(post => {
    const status = post.status || 'pending';
    const statusClass = status === "flagged" ? "flagged" : 
                       status === "deleted" ? "deleted" : 
                       status === "approved" ? "approved" : "";
    
    const postDiv = document.createElement("div");
    postDiv.className = `card post-card ${statusClass}`;
    
    // Show delete button only for admins
    const deleteButton = userRole === 'admin' 
      ? `<button class="btn btn-sm btn-danger" onclick="deletePost(${post.post_id})" ${status === "deleted" ? "disabled" : ""}>ðŸ—‘ Delete</button>`
      : '';
    
    postDiv.innerHTML = `
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h6 class="mb-1">Post #${post.post_id}</h6>
            <div class="small text-muted">
              <strong>User:</strong> ${post.username}<br>
              <span class="badge bg-${getStatusColor(status)}">${status.toUpperCase()}</span>
            </div>
          </div>
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-sm btn-success" onclick="approvePost(${post.post_id})" ${status === "approved" ? "disabled" : ""}>âœ“ Approve</button>
            <button class="btn btn-sm btn-warning" onclick="flagPost(${post.post_id})" ${status === "flagged" ? "disabled" : ""}>âš  Flag</button>
            ${deleteButton}
          </div>
        </div>
        <div class="row">
          <div class="col-md-3"></div>
          <div class="col-md-9">
            <p class="mb-2">${post.caption || 'No caption'}</p>
            <small class="text-muted">${new Date(post.date_created).toLocaleDateString()}</small>
          </div>
        </div>
      </div>
    `;
    
    // Add image if available
    const imgContainer = postDiv.querySelector(".col-md-3");
    if (post.image_path) {
      const img = document.createElement("img");
      img.src = post.image_path;
      img.className = "img-fluid rounded";
      img.style.height = "150px";
      img.style.objectFit = "cover";
      img.style.width = "100%";
      img.onerror = () => imgContainer.appendChild(mkImg("No Image"));
      imgContainer.appendChild(img);
    } else {
      imgContainer.appendChild(mkImg("No Image"));
    }
    
    moderationQueue.appendChild(postDiv);
  });
}

async function approvePost(postId) {
  await updatePostStatus(postId, 'approved');
}

async function flagPost(postId) {
  await updatePostStatus(postId, 'flagged');
}

async function deletePost(postId) {
  if (userRole !== 'admin') {
    alert('Only admins can delete posts.');
    return;
  }
  
  if (confirm("Are you sure you want to delete this post? This action cannot be undone.")) {
    try {
      const response = await fetch(`/api/admin/posts/${postId}`, {
        method: 'DELETE'
      });
      const result = await response.json();
      
      if (result.status === 'success') {
        await loadPosts(); // Reload posts
      } else {
        alert('Failed to delete post: ' + result.message);
      }
    } catch (error) {
      console.error('Error deleting post:', error);
      alert('An error occurred while deleting the post.');
    }
  }
}

async function updatePostStatus(postId, status) {
  try {
    const response = await fetch(`/api/admin/posts/${postId}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status })
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      await loadPosts(); // Reload posts
    } else {
      alert('Failed to update post: ' + result.message);
    }
  } catch (error) {
    console.error('Error updating post status:', error);
    alert('An error occurred while updating the post.');
  }
}

function updateStats() {
  document.getElementById("stat-total-posts").textContent = allPosts.length;
  document.getElementById("stat-flagged").textContent = allPosts.filter(p => (p.status || 'pending') === "flagged").length;
  document.getElementById("stat-pending").textContent = allPosts.filter(p => (p.status || 'pending') === "pending").length;
  document.getElementById("stat-approved").textContent = allPosts.filter(p => (p.status || 'pending') === "approved").length;
}

document.getElementById("searchInput").addEventListener("input", applyFilters);
document.getElementById("statusFilter").addEventListener("change", applyFilters);
document.getElementById("clearFilters").addEventListener("click", () => {
  document.getElementById("searchInput").value = "";
  document.getElementById("statusFilter").value = "all";
  applyFilters();
});

function applyFilters() {
  const searchTerm = document.getElementById("searchInput").value.toLowerCase();
  const statusFilter = document.getElementById("statusFilter").value;
  let filtered = allPosts;

  if (searchTerm) {
    filtered = filtered.filter(post => 
      (post.caption && post.caption.toLowerCase().includes(searchTerm)) ||
      post.username.toLowerCase().includes(searchTerm)
    );
  }

  if (statusFilter !== "all") {
    filtered = filtered.filter(post => (post.status || 'pending') === statusFilter);
  }

  renderPosts(filtered);
}

function getStatusColor(status) {
  const colors = {
    approved: "success",
    pending: "warning",
    flagged: "danger",
    deleted: "secondary"
  };
  return colors[status] || "warning";
}

// Initialize on page load
(async () => {
  const isAuth = await checkAdminAccess();
  if (isAuth) {
    await loadPosts();
  }
})();
</script>
</body>
</html>
