<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FINLOG — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { background: #f7f7f7; }
    .map-container { height: 380px; border-radius: .5rem; }
    .pin-list .pin-item { display:flex; justify-content:space-between; align-items:center; padding:.25rem .5rem; border:1px solid #eee; border-radius:.5rem; margin-bottom:.25rem;}
    .card img { max-height:220px; object-fit:cover; }
    .section-anchor { scroll-margin-top: 72px; }
  </style>
</head>
<body>

<header class="p-2 bg-secondary text-white">
    <div class="d-flex justify-content-between align-items-center">
      <button class="btn btn-outline-light">≡</button>
      <div class="text-center">
        <h1 class="m-0">FINLOG</h1>
        <div class="mt-1">
          <a href="home.html" class="btn btn-outline-light btn-sm me-2">Home</a>
        </div>
      </div>
      <a href="login.html" class="btn btn-outline-light">Login</a>
    </div>
  </header>

<main class="container my-4">

  <!-- Stats Row -->
  <section id="stats" class="section-anchor mb-4">
    <div class="row g-3">
      <div class="col-6 col-md-3">
        <div class="card text-center"><div class="card-body"><h3 id="stat-total">47</h3><div class="text-muted">Total Catches</div></div></div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center"><div class="card-body"><h3 id="stat-species">12</h3><div class="text-muted">Species</div></div></div>
      </div>
      <div class="col-6 col-md-3">
        <div class="card text-center"><div class="card-body"><h3 id="stat-largest">23.5</h3><div class="text-muted">Largest (lbs)</div></div></div>
      </div>
    </div>
  </section>

  <div class="row g-4">
    <!-- Left Column: FinLog -->
    <div class="col-lg-8">
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">FinLog</h5>
          <a href="#upload" class="btn btn-sm btn-secondary">Add New</a>
        </div>
        <div class="card-body">
          <div id="postGrid" class="row g-3"></div>
        </div>
      </div>
    </div>

    <!-- Right Column: Profile + Upload -->
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">Profile</h5></div>
        <div class="card-body text-center">
          <div class="mb-3">
            <div class="bg-secondary text-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width:80px;height:80px;"><span class="h4 mb-0">FM</span></div>
          </div>
          <h5 id="profile-username">FishMaster123</h5>
          <p class="text-muted" id="profile-member-since">Fishing since 2020</p>
          <hr>
          <div class="row text-center">
            <div class="col-6"><h6 id="profile-catches">47</h6><small class="text-muted">Catches</small></div>
            <div class="col-6"><h6 id="profile-species">12</h6><small class="text-muted">Species</small></div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">Quick Actions</h5></div>
        <div class="card-body text-center">
          <a href="upload.html" class="btn btn-primary w-100 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-2" viewBox="0 0 16 16">
              <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
              <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
            </svg>
            Upload New Catch
          </a>
          <a href="map_page.html" class="btn btn-outline-secondary w-100">View Map</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Map -->
  <section id="map" class="mt-5">
    <div class="card">
      <div class="card-header"><h5 class="mb-0">Fishing Map</h5></div>
      <div class="card-body">
        <div id="mapCanvas" class="map-container mb-3"></div>
        <div id="pin-list" class="pin-list"></div>
      </div>
    </div>
  </section>
</main>

<div id="modalHost"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="auth.js"></script>

<script>
let currentUser = null;

// Check authentication on page load
window.addEventListener('DOMContentLoaded', async () => {
  currentUser = await checkAuth();
  if (currentUser) {
    updateNavbarWithUser(currentUser);
    loadUserProfile();
    loadUserPosts();
    loadMapLocations();
  }
});

async function loadUserProfile() {
  // Update profile username and initials
  document.getElementById('profile-username').textContent = currentUser.username;
  document.querySelector('.bg-secondary.text-white.rounded-circle span').textContent = currentUser.username.substring(0, 2).toUpperCase();

  try {
    const response = await fetch(`/api/user/stats`);
    const result = await response.json();

    if (result.status === 'success' && result.data) {
      const stats = result.data;
      const today = new Date();
      const creationDate = new Date(stats.user_creation_date);
      
      // Stats row
      document.getElementById('stat-total').textContent = stats.total_catches || 0;
      document.getElementById('stat-species').textContent = stats.species_count || 0;
      document.getElementById('stat-largest').textContent = stats.largest_catch || 0;

      // Profile card - member since date
      document.getElementById('profile-member-since').textContent = `Fishing since ${creationDate.getFullYear()}`;
      
      // Profile card - stats
      document.getElementById('profile-catches').textContent = stats.total_catches || 0;
      document.getElementById('profile-species').textContent = stats.species_count || 0;
    }
  } catch (error) {
    console.error('Error loading user stats:', error);
  }
}

async function loadUserPosts() {
  try {
    const response = await fetch(`/api/user/posts`);
    const result = await response.json();
    
    if (result.status === 'success' && result.data) {
      const postGrid = document.getElementById('postGrid');
      postGrid.innerHTML = '';
      
      result.data.forEach(post => {
        addPost(post.post_id, post.caption, post.date_created, post.image_path);
      });
      
      // Update stats
      document.getElementById('stat-total').textContent = result.data.length;
    }
  } catch (error) {
    console.error('Error loading posts:', error);
  }
}

function addPost(id, caption, date, imagePath) {
  const postGrid = document.getElementById('postGrid');
  const col = document.createElement('div');
  col.className = 'col-12 col-md-6';
  col.innerHTML = `
    <div class="card h-100">
      <img src="${imagePath}" class="card-img-top" alt="Post image" style="height: 200px; object-fit: cover;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E'">
      <div class="card-body">
        <p class="text-muted small mb-2">${new Date(date).toLocaleDateString()}</p>
        <p class="mb-0">${caption || 'No caption'}</p>
      </div>
    </div>`;
  postGrid.appendChild(col);
}

// === Map ===
const map = L.map("mapCanvas").setView([40.015, -105.27], 10);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution:"© OpenStreetMap contributors" }).addTo(map);

const icon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

// Fetch and display locations from database
async function loadMapLocations() {
  try {
    const response = await fetch('/api/locations');
    const result = await response.json();
    
    if (result.status === 'success' && result.data) {
      const pinList = document.getElementById('pin-list');
      pinList.innerHTML = '';
      
      result.data.forEach(location => {
        const marker = L.marker([location.x_coord, location.y_coord], { icon })
          .addTo(map)
          .bindPopup(`
            <b>${location.username}</b><br>
            ${location.caption || 'No caption'}<br>
            <small>${new Date(location.date_created).toLocaleDateString()}</small>
          `);
        
        const pinItem = document.createElement('div');
        pinItem.className = 'pin-item';
        pinItem.innerHTML = `<small><strong>${location.username}</strong>: ${location.caption || 'No caption'}</small>`;
        pinList.appendChild(pinItem);
      });
      
      if (result.data.length === 0) {
        pinList.innerHTML = '<small class="text-muted">No locations yet</small>';
      }
      
      // Center map on first location if available
      if (result.data.length > 0) {
        map.setView([result.data[0].x_coord, result.data[0].y_coord], 10);
      }
    }
  } catch (error) {
    console.error('Error loading locations:', error);
    document.getElementById('pin-list').innerHTML = '<small class="text-muted">No locations yet</small>';
  }
}

loadMapLocations();

// === Stats ===
function recomputeStats(){document.getElementById('stat-total').textContent=document.querySelectorAll('#postGrid .card').length;}
const obs=new MutationObserver(recomputeStats);obs.observe(postGrid,{childList:true,subtree:true});recomputeStats();
</script>
</body>
</html>
