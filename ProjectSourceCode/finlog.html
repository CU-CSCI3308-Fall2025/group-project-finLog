<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FINLOG</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-light">

  <header class="p-2 bg-secondary text-white">
    <div class="d-flex justify-content-between align-items-center">
      <button class="btn btn-outline-light">â‰¡</button>
      <div class="text-center">
        <h1 class="m-0">FINLOG</h1>
        <div class="mt-1">
          <a href="home.html" class="btn btn-outline-light btn-sm me-2">Home</a>
          <a href="finlog.html" class="btn btn-outline-light btn-sm me-2">Fish Log</a>
          <a href="map_page.html" class="btn btn-outline-light btn-sm me-2">Map</a>
          <a href="upload.html" class="btn btn-outline-light btn-sm me-2">Upload</a>
          <a href="dashboard.html" class="btn btn-outline-light btn-sm">Dashboard</a>
        </div>
      </div>
      <a href="login.html" class="btn btn-outline-light">Login</a>
    </div>
  </header>
  
  <main class="container my-4">
    <h2>Fish Log</h2>
    <div id="postGrid" class="row g-3"></div>
  </main>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const postGrid = document.getElementById("postGrid");

    // Function to render a card and its corresponding modal
    function addPost(post) {
      const id = post.post_id;
      const imagePath = post.image_path;
      const caption = post.caption || 'No caption';
      const username = post.username || 'Unknown';
      const date = new Date(post.date_created).toLocaleDateString();
      
      const card = `
        <div class="col-12 col-sm-6 col-md-4">
          <div class="card text-center">
            <button class="btn p-0" data-bs-toggle="modal" data-bs-target="#modal${id}">
              <img src="${imagePath}" class="card-img-top" alt="Post image" style="height: 200px; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
              <div class="card-body" style="display: none;">No Image Available</div>
            </button>
            <div class="card-footer">
              <small class="text-muted">by ${username}</small>
            </div>
          </div>
        </div>

        <div class="modal fade" id="modal${id}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Post by ${username}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body text-center">
                <img src="${imagePath}" class="img-fluid mb-3" alt="Post image" style="max-height: 400px;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23ddd%22 width=%22100%22 height=%22100%22/%3E%3Ctext fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                <ul class="list-unstyled text-start">
                  <li><strong>Date:</strong> ${date}</li>
                  <li><strong>Caption:</strong> ${caption}</li>
                </ul>
                <button class="btn btn-primary ai-btn mt-2" data-id="${id}">Analyze with AI</button>
                <div id="aiResult${id}" class="mt-3 text-start"></div>
              </div>
            </div>
          </div>
        </div>`;
      postGrid.insertAdjacentHTML("beforeend", card);
    }

    // Simple AI simulation
    function simulateAI(id) {
      const r = document.getElementById("aiResult" + id);
      r.innerHTML = "<strong>Analyzing...</strong>";
      setTimeout(() => {
        r.innerHTML = "<strong>AI Result:</strong> Details";
      }, 1500);
    }

    // Event listener for all AI buttons
    document.addEventListener("click", e => {
      if (e.target.classList.contains("ai-btn")) {
        simulateAI(e.target.dataset.id);
      }
    });

    // Load posts from database
    async function loadPosts() {
      try {
        const response = await fetch('/api/posts');
        const result = await response.json();
        
        if (result.status === 'success' && result.data) {
          postGrid.innerHTML = '';
          result.data.forEach(post => {
            addPost(post);
          });
        }
      } catch (error) {
        console.error('Error loading posts:', error);
      }
    }

    // Load posts on page load
    loadPosts();
  </script>
  <script src="auth.js"></script>
  <script>
    // Check if user is logged in and update navbar
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch('/api/auth/check');
        const result = await response.json();
        
        if (result.authenticated) {
          updateNavbarWithUser(result.user);
        }
      } catch (error) {
        console.log('Not authenticated');
      }
    });
  </script>

</body>
</html>
